name: Windows Build (MSYS2)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-qt5
          mingw-w64-x86_64-ffmpeg
          mingw-w64-x86_64-libass
          mingw-w64-x86_64-taglib
          mingw-w64-x86_64-libcdio
          mingw-w64-x86_64-libcddb
          mingw-w64-x86_64-libgme
          mingw-w64-x86_64-libsidplayfp
          mingw-w64-x86_64-portaudio
          git
          p7zip

    - name: Fix QtWinExtras Symlink
      run: |
        rm -f src/gui/Windows/qt/QtWinExtras
        cp -r src/gui/Windows/qt/qtwinextras_submodule/src/winextras src/gui/Windows/qt/QtWinExtras

    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../install
        ninja
        ninja install

    - name: Package Distribution
      run: |
        mkdir dist
        cp -r install/* dist/
        
        cd dist
        # 查找主程序位置
        exe="QMPlay2.exe"
        if [ ! -f "$exe" ]; then
             if [ -f "bin/QMPlay2.exe" ]; then
                 exe="bin/QMPlay2.exe"
                 cd bin
             fi
        fi
        
        # 自动提取所有依赖 DLL
        deps=$(ldd "$exe" | grep "/mingw64" | awk '{print $3}' | sort | uniq)
        for dep in $deps; do
            cp "$dep" .
        done
        
        # 如果进入了 bin 目录则返回
        if [ "$exe" != "QMPlay2.exe" ]; then
            cd ..
        fi
        
        # 复制 Qt 插件
        target_root="."
        if [ -d "bin" ]; then target_root="bin"; fi
        
        mkdir -p "$target_root/platforms"
        cp /mingw64/share/qt5/plugins/platforms/qwindows.dll "$target_root/platforms/"
        
        mkdir -p "$target_root/styles"
        cp /mingw64/share/qt5/plugins/styles/*.dll "$target_root/styles/" || true

        mkdir -p "$target_root/imageformats"
        cp /mingw64/share/qt5/plugins/imageformats/*.dll "$target_root/imageformats/" || true
        
        mkdir -p "$target_root/iconengines"
        cp /mingw64/share/qt5/plugins/iconengines/*.dll "$target_root/iconengines/" || true
        
        cd ..
        7z a -tzip 扣货科技-Windows.zip dist/*

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 扣货科技-Windows-Package
        path: 扣货科技-Windows.zip
