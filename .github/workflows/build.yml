name: Windows Build (MSYS2)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-qt5
          mingw-w64-x86_64-ffmpeg
          mingw-w64-x86_64-libass
          mingw-w64-x86_64-taglib
          mingw-w64-x86_64-libcdio
          mingw-w64-x86_64-libcddb
          mingw-w64-x86_64-libgme
          mingw-w64-x86_64-libsidplayfp
          mingw-w64-x86_64-portaudio
          git
          p7zip

    - name: Fix QtWinExtras Symlink
      run: |
        rm -f src/gui/Windows/qt/QtWinExtras
        cp -r src/gui/Windows/qt/qtwinextras_submodule/src/winextras src/gui/Windows/qt/QtWinExtras

    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../install
        ninja
        ninja install

    - name: Package Distribution
      shell: msys2 {0}
      run: |
        mkdir -p dist
        
        # Copy Executable (Renaming to Chinese name)
        # 'ninja install' puts artifact in root of install dir for WIN32
        cp install/QMPlay2.exe dist/扣货科技.exe
        
        # Copy libqmplay2.dll
        # It's installed in the same prefix as executable on Windows
        if [ -f "install/libqmplay2.dll" ]; then
             cp install/libqmplay2.dll dist/
        elif [ -f "install/bin/libqmplay2.dll" ]; then
             cp install/bin/libqmplay2.dll dist/
        else
             echo "Error: libqmplay2.dll not found!"
             ls -R install
             exit 1
        fi
        
        # Copy qt.conf
        if [ -f "qt.conf" ]; then
          cp qt.conf dist/
        fi

        # Copy Translation
        mkdir -p dist/lang
        cp build/lang/zh_CN.qm dist/lang/

        # Copy Modules (Plugins)
        # modules are in install/modules
        mkdir -p dist/modules
        cp -r install/modules/* dist/modules/
        
        # Copy Qt Plugins
        mkdir -p dist/plugins/platforms
        cp /mingw64/share/qt5/plugins/platforms/qwindows.dll dist/plugins/platforms/
        
        mkdir -p dist/plugins/styles
        cp /mingw64/share/qt5/plugins/styles/*.dll dist/plugins/styles/ || true

        mkdir -p dist/plugins/imageformats
        cp /mingw64/share/qt5/plugins/imageformats/*.dll dist/plugins/imageformats/ || true
        
        mkdir -p dist/plugins/iconengines
        cp /mingw64/share/qt5/plugins/iconengines/*.dll dist/plugins/iconengines/ || true
        
        # Recursively copy DLL dependencies
        copy_dlls() {
            local changed=1
            while [ $changed -eq 1 ]; do
                changed=0
                # Find all .exe and .dll files in dist (including subdirectories like modules/)
                local binaries=$(find dist -type f \( -name "*.exe" -o -name "*.dll" \))
                
                for bin in $binaries; do
                    # Get list of dependencies
                    local deps=$(ldd "$bin" | grep "mingw64" | awk '{print $3}' | sort | uniq)
                    for dep in $deps; do
                        local dep_name=$(basename "$dep")
                        if [ ! -f "dist/$dep_name" ]; then
                            echo "Copying dependency: $dep_name for $(basename $bin)"
                            cp "$dep" "dist/"
                            changed=1
                        fi
                    done
                done
            done
        }
        
        copy_dlls

        # Explicitly copy PortAudio dependencies if missing
        # This is a common cause for "no sound"
        if [ ! -f "dist/libportaudio-2.dll" ]; then
             if [ -f "/mingw64/bin/libportaudio-2.dll" ]; then
                 cp /mingw64/bin/libportaudio-2.dll dist/
                 echo "Explicitly copied libportaudio-2.dll"
             fi
        fi

        # Create Zip
        cd dist
        7z a -tzip ../扣货科技-Windows.zip *

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 扣货科技-Windows-Package
        path: 扣货科技-Windows.zip
