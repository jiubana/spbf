name: Windows Build (MSYS2)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-qt5
          mingw-w64-x86_64-ffmpeg
          mingw-w64-x86_64-libass
          mingw-w64-x86_64-taglib
          mingw-w64-x86_64-libcdio
          mingw-w64-x86_64-libcddb
          mingw-w64-x86_64-libgme
          mingw-w64-x86_64-libsidplayfp
          mingw-w64-x86_64-portaudio
          git
          p7zip

    - name: Fix QtWinExtras Symlink
      run: |
        rm -f src/gui/Windows/qt/QtWinExtras
        cp -r src/gui/Windows/qt/qtwinextras_submodule/src/winextras src/gui/Windows/qt/QtWinExtras

    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../install
        ninja
        ninja install

    - name: Package Distribution
      run: |
        mkdir dist
        cp -r install/* dist/
        
        cd dist
        # Copy dependencies using ldd
        # We target QMPlay2.exe which should be in the root of dist if CMAKE_INSTALL_PREFIX was respected for WIN32
        exe="QMPlay2.exe"
        if [ ! -f "$exe" ]; then
             echo "QMPlay2.exe not found in root, checking bin.."
             if [ -f "bin/QMPlay2.exe" ]; then
                 exe="bin/QMPlay2.exe"
                 cd bin
             else
                 echo "Error: QMPlay2.exe not found!"
                 ls -R
                 exit 1
             fi
        fi
        
        echo "Resolving dependencies for $exe..."
        deps=$(ldd "$exe" | grep "/mingw64" | awk '{print $3}' | sort | uniq)
        for dep in $deps; do
            cp "$dep" .
        done
        
        # Go back to dist root if we went into bin
        if [ "$exe" != "QMPlay2.exe" ]; then
            cd ..
        fi
        
        # Copy Qt plugins
        # Ensure target directories exist. If exe is in bin, plugins typically go to bin/platforms
        # But if exe is in root, plugins go to platforms
    - name: Package Distribution
      shell: msys2 {0}
      run: |
        mkdir -p dist
        
        # Copy Executable
        cp bin/扣货科技.exe dist/
        
        # Copy qt.conf
        if [ -f "qt.conf" ]; then
          cp qt.conf dist/
        fi

        # Copy Translation
        mkdir -p dist/lang
        cp lang/zh_CN.qm dist/lang/

        # Copy Modules (Plugins)
        # Verify where modules are built. Usually in src/modules or bin/modules
        mkdir -p dist/modules
        # Try finding modules from build dir
        find src/modules -name "*.dll" -exec cp {} dist/modules/ \;
        
        # Copy Qt Plugins
        # We manually copy specific plugins we know we need
        mkdir -p dist/plugins/platforms
        cp /mingw64/share/qt5/plugins/platforms/qwindows.dll dist/plugins/platforms/
        
        mkdir -p dist/plugins/styles
        cp /mingw64/share/qt5/plugins/styles/*.dll dist/plugins/styles/ || true

        mkdir -p dist/plugins/imageformats
        cp /mingw64/share/qt5/plugins/imageformats/*.dll dist/plugins/imageformats/ || true
        
        mkdir -p dist/plugins/iconengines
        cp /mingw64/share/qt5/plugins/iconengines/*.dll dist/plugins/iconengines/ || true
        
        # Recursively copy DLL dependencies
        # This function loops until no new DLLs are added
        copy_dlls() {
            local changed=1
            while [ $changed -eq 1 ]; do
                changed=0
                # Find all .exe and .dll files in dist
                local binaries=$(find dist -name "*.exe" -o -name "*.dll")
                
                for bin in $binaries; do
                    # Get list of dependencies
                    local deps=$(ldd "$bin" | grep "mingw64" | awk '{print $3}' | sort | uniq)
                    for dep in $deps; do
                        local dep_name=$(basename "$dep")
                        if [ ! -f "dist/$dep_name" ]; then
                            echo "Copying dependency: $dep_name for $(basename $bin)"
                            cp "$dep" "dist/"
                            changed=1
                        fi
                    done
                done
            done
        }
        
        copy_dlls

        # Create Zip
        cd dist
        7z a -tzip ../扣货科技-Windows.zip *

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 扣货科技-Windows-Package
        path: 扣货科技-Windows.zip
